### 简介

Redis在哨兵模式和集群模式下，当主节点出现故障时，会通过重新选举的方式将某个从节点升级为主节点，然后继续对外提供服务。

#### 

### 哨兵模式下的选举

由于哨兵模式下会存在一个或多个协调者（即Sentinel节点），Sentinel节点会监听任意多个主服务器以及这些主服务器下所属的从服务器，在主服务器下线时，自动将下线主服务器的某个从服务器升级为新的主服务器，当原来的主服务器上线后，Sentinel会将其设置为新主服务器的从服务器。

#### 头领Sentinel选举

当主服务器出现故障时，监视这个主服务器的各个Sentinel会进行协商，选举出一个头领Sentinel，并由头领对下线的主服务器进行故障转移。

##### 选举规则和方法

1.每个Sentinel都有资格成为头领

2.无论选举是否成功，Sentinel的纪元（Epoch）都会自增一次。

3.在同一个纪元里，每个Sentinel都有一次机会将某个Sentinel设置为头领，并且一旦设置成功，在这个纪元里将无法再修改。

4.每个发现主服务器下线的Sentinel都会要求其他Sentinel设置为头领。

5.先到先得原则，当Sentinel接收到头领选票请求时，如果之前没有设置过，则会接受选票请求，否则不会。

6.必须拥有超过Sentinel数量一半以上的选票，才能成为头领。

7.选举是有时间限制的，超过时间限制没有选举出头领，则会开启下一个纪元，并重新进行选举。

8.发送选票的命令为SENTINELis-master-down-by-addr，与单个Sentinel发现主服务器宕机，并与其他Sentinel确认时的命令一致，但是会额外带上发送选票的Sentinel的ID。



#### 故障转移

当选举出头领Sentinel后，头领Sentinel将对下线的主服务器进行故障转移。

##### 主要步骤

1.在已下线的主服务器的所有从服务器里面挑选出一个从服务器，将其转换为主服务器。

​	为了选出合适的从服务器，Sentinel会按照以下规则进行一层层过滤，

​	1.1 去除下线或者断线的从服务器

​	1.2 去除最近五秒内没有与头领Sentinel发送过心跳的从服务器

​	1.3 去除与原主服务器断开连接超过down-after-milliseconds*10毫秒的从服务器

​	当过滤完成以后，如果仍然存在多个从服务器，那么会根据复制偏移量（见主从复制）、从服务器的ID进行排序，选取最优的服务器，然后选举出来的从服务器执行SLAVEOF  no one，成为新的主服务器。

2.让已下线的主服务器的所有从服务器改为新主服务器的从服务器。即重新执行slave of命令

3.当原主服务器重新上线时，将其设置为新主服务器的从节点。



### 集群模式下的选举

与哨兵模式不同，集群模式下，每个节点都会向集群中的其他节点定时发送PING消息，以此来检测对方是否在线，因此，可以这么理解，每个集群下的节点都是Sentinel节点，都会保存所有节点信息，都能参与判定节点是否下线，但是参与选举投票时，必须是要求为主节点。

#### 选举规则和方法

1.集群的配置纪元增一。

2.对于每个纪元，集群中每个负责处理Slot（槽）的主节点，有且仅有一次投票机会，第一个向该主节点发送选票的从节点将获得主节点的支持。

3.每个从节点发现主节点下线时，都会通过广播的方式，向集群中广播一条CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST消息，这条消息会要求所有有投票权的节点将选票投向自己，前提是该节点并未投给其他从节点。

4.从节点会收集各个主节点返回的消息，根据自己收到多少条消息来统计自己收到多少张选票。

5.选票超过所有主节点数量一半的从节点称为新的主节点。

6.每个纪元都必须在规定时间内选举完成，否则将重新选举。









