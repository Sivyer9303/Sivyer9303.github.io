### 简介

Redis集群是Redis官方提供的分布式解决方案，集群通过分片来进行数据共享，并提供复制和故障转移功能。

#### 节点

一个Redis集群通常由多个节点组成，在刚开始时，每个节点都是相互独立的，他们都处于一个只包含自己的集群中，要组件一个真正的可工作的集群，必须将各个独立的节点连接起来。

连接命令

`CLUSTER MEET <ip>  <port>`

在命令发送后，可以让节点与指定的节点进行握手，握手成功后，节点就会将ip和port所指定的节点添加到当前节点所在的集群中，因此连接命令的发起方是已经在集群中的节点，而不是待加入集群的节点。

#### 槽指派

Redis通过分片的形式来保存数据库中的键值对，集群中的整个数据库会被分为16384个槽，数据库中的每个键都属于这16384个槽中的一个，集群中的每个节点可以处理0~16384个槽。

16384个槽必须每个都有节点与之对应，否则Redis集群会处于下线状态。

分配槽的命令

`CLUSTER ADDSLOTS <slot> [slot ...]`

#### 槽指派信息的传播

节点除了将自己负责处理的槽记录在clusterNode结构中之外，还会将自己的slots数组通过消息的形式发送给集群中的其他节点，以此来告知其他节点自己负责处理的槽。



#### 计算键属于哪个槽

采用的[clusterslot](./2021-05-31-clusterslot.md)中的slot算法。

#### 集群命令重定向

当客户端向节点发送与数据库键相关的命令时，接受命令的节点会计算出命令要处理的数据库键属于哪个槽，并检查是否指派给自己，如果是，则直接执行命令，否则，会返回给客户端一个MOVED错误，指引客户端重定向至正确的节点。

MOVED错误会包含键所在的槽、负责处理槽的节点ip和端口号。



#### 重新分片

Redis集群中的重新分片操作可以将任意数量的槽重新分配给某个节点，并且相关槽的键值对也会被移动至对应节点。

##### 实现原理

重新分片操作是由Redis提供的集群管理软件redis-trib执行的，由以下几个步骤完成重新分片

1.redis-trib对目标节点发送CLUSTER SETSLOT＜slot＞IMPORTING＜source_id＞命令，让目标节点准备好从源节点导入（import）属于槽slot的键值对。

2.redis-trib对源节点发送CLUSTER SETSLOT＜slot＞MIGRATING＜target_id＞命令，让源节点准备好将属于槽slot的键值对迁移（migrate）至目标节点。

3.redis-trib向源节点发送CLUSTERGETKEYSINSLOT＜slot＞＜count＞命令，获得最多count个属于槽slot的键值对的键名（keyname）。

4.对于步骤3获得的每个键名，redis-trib都向源节点发送一个MIGRATE＜target_ip＞＜target_port＞＜key_name＞0＜timeout＞命令，将被选中的键原子地从源节点迁移至目标节点。

5.重复执行步骤3和步骤4，直到源节点保存的所有属于槽slot的键值对都被迁移至目标节点为止。每次迁移键的过程如图17-24所示。

6.redis-trib向集群中的任意一个节点发送CLUSTER SETSLOT＜slot＞NODE＜target_id＞命令，将槽slot指派给目标节点，这一指派信息会通过消息发送至整个集群，最终集群中的所有节点都会知道槽slot已经指派给了目标节点。



##### ASK错误

在重新分片期间，如果此时接受到与需要迁移的键值对相关的命令时，源节点会根据数据是否在自己的数据库中来决定是否需要重定向，如果在，则直接执行命令，如果不在，则重定向到目标节点。

