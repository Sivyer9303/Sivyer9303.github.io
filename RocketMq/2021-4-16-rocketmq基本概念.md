### RocketMq基本概念

#### RocketMq组成部分

##### 生产者

生产者是指RocketMq中的消息生产的部分，是消息的起点。

###### 支持的发送类型

生产者发送消息支持同步发送、异步发送、顺序发送、单向发送。

同步发送:生产者将消息发送至Broker，必须得到Broker的确认消息才能确认发送成功。

异步发送：生产者发送消息后，通过future来判定是否发送成功。通过在异步方法中添加SendCallback，来监听				消息发送情况，根据是否成功来决定是否回滚等。

顺序发送：RocketMq的顺序消息只能保证单个message queue内的顺序消费，因此，为了保证能够实现顺序消息，在生产者发送消息时，通过选择message queue，将同一批的消息发送到同一个messag queue，即可实现顺序消费。通过在发送消息时，添加MessageQueueSelector 参数，即可自定义messge queue的选择。同时，消费者在消费时，也需要保证顺序消费，通过选择MessageListenerConcurrently监听器即可实现。

单向发送：单向发送是最不靠谱的发送方式，使用时请注意使用场景。单向发送在发送完成以后，不会接受Broker返回来的信息，发送完成以后就不管了。

###### 生产者发送策略

生产者的发送策略决定了当前生产者发送消息到具体哪个queue中，默认为轮询。

轮询：根据queue数量，轮流进行消息发送。

最小延迟：因为每个queue的消息积压情况都有不同，那么在发送时，会记录上一次发送的延迟，通过选择最小延迟的队列来发送消息，在发送失败时，会退化为轮询。

随机：由MessageQueueSelector接口的子类SelectMessageQueueByRandom来实现，简单来说就是生成一个小于队列数量的随机数，然后根据随机数获取对应队列。

hash：由MessageQueueSelector接口的子类SelectMessageQueueByHash来实现，通过对附加参数进行取模，然后对队列数取余，然后根据结果获取对应队列。

机房：根据机房来决定发送到哪个队列，开源项目中并没有提供默认的实现方式，需要自己去实现，大概思路是，通过中间件或者数据库保存生产者和机房的关联关系、队列和机房的关联关系，如果对于消息的延迟接受度稍微高一点，可以考虑把机房和地区的关系也维护起来，将可选的队列扩展到地区级别。



##### 消费者

消费者是指RocketMq中实际进行消息消费的部分，可以是集群，也可以是单机。

###### 消息消费模式

消费者支持两种消费模式，一种是广播模式，一种是集群模式。

广播模式：消息会被所有消费者获取到，不需要消费者返回ack标识。

集群模式：同一个consumerGroupId下的消费者，同一个消息只会被一个消费者获取到，需要返回ack标识给Broker以确认消费成功。

###### 消息拉取模式

消费者支持两种消息拉取模式，pull模式和push模式，本质上push模式是RocketMq对于pull模式的一种封装，仍然是消费者主动去获取，而不是Broker去推送，避免将压力全放到Broker上。

pull模式：通过consumer调用fetch方法（可以阻塞或者不阻塞）获取未消费的消息。

push模式：添加消息监听器即可。

###### 顺序消费

在生产者发送顺序消息后，消费者只需添加顺序消息监听器即可，因为消费者在启动完成后，会根据现有消费者数量和message queue数量，进行message queue和消费者的匹配，每个message queue会对应一个消费者，一个消费者可以对应多个message queue。

