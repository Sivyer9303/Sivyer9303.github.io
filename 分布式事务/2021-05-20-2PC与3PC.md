### 2PC

2PC(tow phase commit)两阶段提交顾名思义它分成两个阶段，先由一方进行提议(propose)并收集其他节点的反馈(vote)，再根据反馈决定提交(commit)或中止(abort)事务。我们将提议的节点称为协调者(coordinator)，其他参与决议节点称为参与者(participants, 或cohorts)。

#### 2PC的过程

1.协调者向所有参与者发起提议

2.每个参与者执行自己的逻辑

3.协调者收集参与者的反馈，决定是进行提交还是回滚并通知所有参与者。

#### 2PC存在的问题

1.同步阻塞：所有参与者都执行完自己的逻辑以后，才能进行分布式事务的提交或者回滚，这使得一旦存在执行之间过长的参与者逻辑，会导致整个逻辑全部阻塞住，无法进行后续步骤。

2.单点故障：非常依赖协调者，如果协调者出现问题，则会导致整个系统不可用。如果协调者是分布式的，则必须能够做到事务能够无缝衔接。

3.数据不一致性：当协调者通知参与者进行提交或回滚时，如果只通知了一部分的时候出现了网络异常，会导致参与者出现结果的不一致性。

4.不确定性：当某个参与者在收到commit指令后，参与者和协调者都出现故障，会导致无法确切的知道结果。

#### 2pc的补偿版本-TCC

TCC - Try - confirm - Cancel的缩写，在TCC下，事务发起者充当协调者的角色，每个参与者提供3个接口供发起者调用（可以使用中间件来解耦，例如mq）。

主要有以下几个步骤

Try 阶段：尝试执行，完成所有业务检查（一致性）, 预留必须业务资源（准隔离性）
Confirm 阶段：确认执行真正执行业务，不作任何业务检查，只使用 Try 阶段预留的业务资源，Confirm 操作满足幂等性。要求具备幂等设计，Confirm 失败后需要进行重试。
Cancel 阶段：取消执行，释放 Try 阶段预留的业务资源 Cancel 操作满足幂等性 Cancel 阶段的异常和 Confirm 阶段异常处理方案基本上一致



### 3PC

3pc是2pc的进阶版，相对于2pc来说，多了一个阶段。

#### 3PC的过程

1.协调者向所有参与者发起提议

2.参与者执行自己的逻辑

3.协调者根据参与者执行的结果，决定进入preCommit状态还是告知参与者回滚

4.协调者告知参与者进行提交或者回滚。

#### 3PC解决的问题

3pc相对于2pc来说，多了一个中间状态，preCommit状态，此状态可以保证当协调者和参与者都挂了以后，重新恢复时，能够根据协调者的状态来判断是否需要提交。







#### 

